C51 COMPILER V9.56.0.0   MAIN                                                              03/03/2019 00:02:17 PAGE 1   


C51 COMPILER V9.56.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\main
                    -.lst) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          #include<reg52.h>
   2          #include<intrins.h>
   3          #include "delay.h"
   4          #include "lcd1602.h"
   5          #include "steper.h"
   6          #include "keypress.h"
   7          
   8          uchar dishu_sheding = 0;
   9          uchar dishu_shiji = 0;
  10          uchar diandi_number = 0;
  11          uchar Number = 0;
  12          
  13          sbit buzzer = P2^3;
  14          
  15          /*******************************************************************************
  16          * 函 数 名       : Timer_Init()
  17          * 函数功能       : 设置定时
  18          * 输    入       : 无
  19          * 输    出       : 无
  20          *******************************************************************************/
  21          void Timer_Init()
  22          {
  23   1        TMOD = 0x11;//定时器0定时器1为工作方式1
  24   1        /*  装载初值  */
  25   1        TH0 = (65536-50000)/256;
  26   1        TL0 = (65536-50000)%256;
  27   1        
  28   1        EA = 1;//开总中断
  29   1        /*  开启定时器中断  */
  30   1        ET0 = 1;//定时器0
  31   1        /*  启动定时器  */
  32   1        TR0 = 1;//定时器0
  33   1        /*  外部中断  */
  34   1        EX0 = 1;
  35   1        EX1 = 1;
  36   1        IT0 = 1;
  37   1        IT1 = 1;
  38   1      }
  39          
  40          /*******************************************************************************
  41          * 函 数 名       : UsartConfiguration()
  42          * 函数功能       : 设置串口
  43          * 输    入       : 无
  44          * 输    出       : 无
  45          *******************************************************************************/
  46          
  47          void UsartConfiguration()
  48          { 
  49   1        SCON=0X50;      //设置为工作方式1,8位数据，可变波特率
  50   1        TMOD=0X20;      //设置计数器工作方式2
  51   1        PCON=0X00;      //波特率不加倍
  52   1        TH1=0XFd;       //计数器初始值设置，9600@11.0592MHz
  53   1        TL1=0XFd;
  54   1        TR1=1;          //打开计数器
C51 COMPILER V9.56.0.0   MAIN                                                              03/03/2019 00:02:17 PAGE 2   

  55   1        ES = 1;         //开串口中断
  56   1        EA = 1;         //开总中断
  57   1      }
  58          
  59          
  60          /*------------------------------------------------
  61           中断0函数，检测滴管里面下落点滴的数量
  62          ------------------------------------------------*/
  63          void Interrupt0() interrupt 0
  64          {
  65   1        diandi_number++;
  66   1      }
  67          /*------------------------------------------------
  68          定时计数0，设定为10s，检测点滴速度，时间越长，精度越高
  69          ------------------------------------------------*/
  70          void T0_Time() interrupt 1 
  71          {
  72   1        /*  重装初值  */
  73   1        TH0 = (65536-50000)/256;
  74   1        TL0 = (65536-50000)%256;
  75   1        Number++;
  76   1        if(Number==20*10)
  77   1        {
  78   2          Number = 0;
  79   2          dishu_shiji = diandi_number*6;
  80   2          if((dishu_shiji-dishu_sheding)>6)//自动校正流速程序
  81   2          {
  82   3            Move(1,10);
  83   3          }
  84   2          else if((dishu_shiji-dishu_sheding)<-6)
  85   2          {
  86   3            Move(0,10);
  87   3          }
  88   2          else;
  89   2          
  90   2          diandi_number = 0;
  91   2        }
  92   1      }
  93          /*------------------------------------------------
  94           中断1函数，检测点滴袋是否有液体，当发生中断，蜂鸣器报警
  95          ------------------------------------------------*/
  96          void Interrupt1() interrupt 2
  97          {
  98   1        buzzer = 0;
  99   1      }
 100          
 101          /********************************************************************
 102          * 名称 : Com_Int()
 103          * 功能 : 串口中断子函数
 104          * 输入 : 无 * 输出 : 无
 105          ***********************************************************************/
 106          void Com_Int(void) interrupt 4
 107          {
 108   1        uchar i;
 109   1        uchar receive_data;
 110   1        
 111   1        EA = 0;
 112   1        
 113   1        if(RI == 1) //当硬件接收到一个数据时，RI会置位
 114   1        {     
 115   2          RI = 0;
 116   2          receive_data = SBUF;//接收到的数据
C51 COMPILER V9.56.0.0   MAIN                                                              03/03/2019 00:02:17 PAGE 3   

 117   2            
 118   2          if(receive_data == '1')  
 119   2          {
 120   3              //LED =0;
 121   3          }
 122   2          else
 123   2          {
 124   3              //LED =1; 
 125   3          }
 126   2          
 127   2        }
 128   1          
 129   1          for(i=0; i<36; i++)
 130   1          {
 131   2            SBUF = dishu_shiji;   //将要发送的数据放入到发送寄存器
 132   2            while(!TI);       //等待发送数据完成
 133   2            TI=0;             //清除发送完成标志位
 134   2            DelayMs(1);
 135   2          }
 136   1          EA = 1;
 137   1      }
 138          
 139          
 140          void main()
 141          {
 142   1        
 143   1        uchar keyvalue;//键值
 144   1        uchar k;//设定滴数显示的位置
 145   1        uchar value[3]={0,0,0};//保存输入设定滴数的值,默认为0
 146   1        uchar i;//临时变量
 147   1        
 148   1        Timer_Init();//初始化定时
 149   1        UsartConfiguration();//初始化串口
 150   1        lcd1602_init();
 151   1        
 152   1        while(1)
 153   1        {   
 154   2          lcd1602_clear();//清屏
 155   2          lcd1602_write_string(0,0,"now:");
 156   2          lcd1602_write_string(9,0,"d/min");
 157   2          lcd1602_write_string(0,1,"set:");
 158   2          lcd1602_write_string(9,1,"d/min");
 159   2          lcd1602_write_char(6,0,'0'+dishu_shiji/100);
 160   2          lcd1602_write_char(7,0,'0'+dishu_shiji%100/10);
 161   2          lcd1602_write_char(8,0,'0'+dishu_shiji%10);
 162   2          
 163   2          
 164   2            
 165   2          if (KeyPress())
 166   2              {//按键处理程序
 167   3                  keyvalue = KeyScan();
 168   3                
 169   3                  if (keyvalue ==14)
 170   3                  {//手动校准步进电机
 171   4                    DelayMs(200);//去抖
 172   4                    while(1)
 173   4                    {
 174   5                      if(KeyPress())
 175   5                      {
 176   6                        keyvalue = KeyScan();
 177   6                        if(keyvalue == 11)//正向调整
 178   6                        {
C51 COMPILER V9.56.0.0   MAIN                                                              03/03/2019 00:02:17 PAGE 4   

 179   7                          Move(1,10);
 180   7                        }           
 181   6                        if(keyvalue == 12)//反向调整
 182   6                        {
 183   7                          Move(0,10);
 184   7                        }
 185   6                        if(keyvalue ==16)//退出
 186   6                        {
 187   7                          break;
 188   7                        }
 189   6                        while (KeyPress());
 190   6                      }
 191   5                    } 
 192   4                  }
 193   3                  
 194   3                  if(keyvalue ==15)
 195   3                  {//设置显示模式
 196   4                    DelayMs(200);//去抖
 197   4                    while(1)
 198   4                    {
 199   5                      if(KeyPress())
 200   5                      {
 201   6                        keyvalue = KeyScan();
 202   6                        if(keyvalue ==11)//向左滚动
 203   6                        {
 204   7                            i=40;
 205   7                            while(i--)
 206   7                            {
 207   8                              DelayMs(200);
 208   8                              lcd1602_turn_right();
 209   8                            }   
 210   7                        }
 211   6                        if(keyvalue ==12)//向右滚动
 212   6                        {
 213   7                            i=40;
 214   7                            while(i--)
 215   7                            {
 216   8                              DelayMs(200);
 217   8                              lcd1602_turn_left();
 218   8                            }
 219   7                        }
 220   6                        if(keyvalue ==16)//清屏并退出
 221   6                        {
 222   7                          lcd1602_clear();
 223   7                          break;
 224   7                        }
 225   6                        while (KeyPress());
 226   6                      }
 227   5                    }
 228   4                    
 229   4                  }
 230   3                  
 231   3                  
 232   3                  
 233   3                  
 234   3                  if(keyvalue==13)
 235   3                  {//设定滴数
 236   4                    DelayMs(200);//去抖
 237   4                    k=6;
 238   4                    while(1)
 239   4                    {
 240   5                      DelayMs(200);//去抖
C51 COMPILER V9.56.0.0   MAIN                                                              03/03/2019 00:02:17 PAGE 5   

 241   5                      if(KeyPress())
 242   5                      {
 243   6                        keyvalue = KeyScan();
 244   6                        if(keyvalue==0||keyvalue==1||keyvalue==2||keyvalue==3||keyvalue==4||keyvalue==5||keyvalue==6||key
             -value==7||keyvalue==8||keyvalue==9)
 245   6                        {
 246   7                          if(k==6)
 247   7                          {
 248   8                            value[0]=keyvalue;
 249   8                          }
 250   7                          else if(k==7)
 251   7                          {
 252   8                            value[1]=keyvalue;
 253   8                          }
 254   7                          else if(k==8)
 255   7                          {
 256   8                            value[2]=keyvalue;
 257   8                          }
 258   7                          keyvalue = '0'+ keyvalue;           
 259   7                          lcd1602_write_char(k,1,keyvalue);
 260   7                        }
 261   6                        else if(keyvalue == 11)
 262   6                        {
 263   7                          k=k-1;
 264   7                        }
 265   6                        else if(keyvalue == 12)
 266   6                        {
 267   7                          k=k+1;
 268   7                        }
 269   6                        else if (keyvalue==16)
 270   6                        {
 271   7                          dishu_sheding = value[0]*100+value[1]*10+value[2]; 
 272   7                          break;
 273   7                        }
 274   6                        else;
 275   6                        while (KeyPress());
 276   6                      }
 277   5                    }
 278   4                  }
 279   3                  while (KeyPress());
 280   3              }
 281   2          DelayMs(200);
 282   2        }
 283   1      } 
 284          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1187    ----
   CONSTANT SIZE    =     19    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      6       6
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
